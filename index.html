<!DOCTYPE html>
<html>
<head>
  <title>Dustin Larimer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <p>Ohhai, friend! I'm Dustin Larimer.</p>
  <h1>I help people make things.</h1>
  <p>I also
    <a href="https://medium.com/@larimer">write</a>,
    <a href="https://twitter.com/larimer">tweet</a>,
    <a href="https://github.com/dustinlarimer">code</a>,
    <a href="https://soundcloud.com/larimer">bop my head</a>, and
    <a href="https://instagram.com/dustinlarimer">take pics</a>.</p>

  <form action="" id="messenger" method="GET">
    <label id="messenger-label" for="messenger-input">What's your name?</label>
    <textarea id="messenger-input" placeholder="reply"></textarea>
  </form>

  <script src="https://d26b395fwzu5fz.cloudfront.net/3.2.4/keen-tracker.min.js"></script>
  <script src="js/ready.min.js"></script>
  <script>
  var form, label, input, client, convo;

  function init(){
    form = document.getElementById('messenger');
    label = document.getElementById('messenger-label');
    input = document.getElementById('messenger-input');

    convo = {
      marker: 'name',
      name: {
        label: 'What\'s your name?',
        placeholder: 'reply',
        reply: ''
      },
      message: {
        label: 'Hello, {Name}! How can I help you?',
        placeholder: 'reply',
        reply: ''
      },
      contact: {
        label: 'What\'s the best way to reach you?',
        placeholder: 'reply',
        reply: ''
      },
      thanks: {
        label: 'Roger that, {Name}!',
        placeholder: 'thanks :)',
        reply: undefined
      }
    };

    if (window.addEventListener) {
      input.addEventListener('keydown', handleKeypress);
      form.addEventListener('submit', handleSubmit);
    }
    else {
      input.attachEvent('onkeydown', handleKeypress);
      form.attachEvent('onsubmit', handleSubmit);
    }

    initAnalytics();
  }

  function handleCompletion(){
    client.addEvent('message', {
      message: {
        name: convo['name'].reply,
        text: convo['message'].reply,
        contact: convo['contact'].reply
      }
    });
  }

  function handleKeypress(e){
    if (e.keyCode === 13) {
      handleSubmit(input.value);
    }
    else {
      resetTextareaHeight();
    }
  }

  function handleSubmit(e){
    if (e && e.preventDefault) {
      e.preventDefault();
    }
    convo[convo.marker].reply = input.value;
    switch (convo.marker) {
      case 'name':
        convo.marker = 'message';
        break;
      case 'message':
        convo.marker = 'contact';
        break;
      case 'contact':
        convo.marker = 'thanks';
        input.disabled = true;
        handleCompletion();
        // console.log(convo);
        break;
    }
    input.blur();
    input.value = '';
    label.innerHTML = convo[convo.marker]['label'].replace('{Name}', convo['name'].reply);
    input.placeholder = convo[convo.marker]['placeholder'];
    setTimeout(function(){
      input.focus();
    }, 500);

  }

  function resetTextareaHeight(len){
    var len = input.value.length;
    var width = input.clientWidth;
    input.style.minHeight = len / (width/23) * 70 + "px";
  }

  function initAnalytics(){
    client = new Keen({
      projectId: "51a3a10a38433136b2000002",
      writeKey: "29e09a8313b49acf86a4fedb331155540526596f5b92cf4b7f90bfbb426e03e967e9fd2f06e45b17d512125f5479cd069b1f687ac7a3ab2aa143cfc95eb167f2b16ce07299fa71b2601c5330606747dcc0dbeeaa541d3451cac68dfd47dba94a2c1614f33c835f5b703613406e6c7b14",
      requestType: "xhr"
    });

    client.setGlobalProperties(function(collection){
      return {
        page: {
          title: document.title,
          host: document.location.host,
          href: document.location.href,
          path: document.location.pathname,
          protocol: document.location.protocol.replace(/:/g, ''),
          query: document.location.search
        },
        referrer: {
          url: document.referrer
        },
        tech: {
          ip_address: "${keen.ip}",
          user_agent: "${keen.user_agent}"
        },
        keen: {
          timestamp: new Date().toISOString(),
          addons: [
            {
              "name"   : "keen:ip_to_geo",
              "input"  : { "ip": "tech.ip_address" },
              "output" : "geo"
            },
            {
              "name"   : "keen:ua_parser",
              "input"  : { "ua_string": "tech.user_agent" },
              "output" : "tech"
            },
            {
              "name"   : "keen:url_parser",
              "input"  : { "url": "page.href" },
              "output" : "page.info"
            },
            {
              "name"   : "keen:referrer_parser",
              "input"  : { "referrer_url": "referrer.url", "page_url": "page.href" },
              "output" : "referrer.info"
            }
          ]
        }
      };
    });

    client.addEvent("pageview");
  }

  domready(init);
  </script>
</body>
</html>
